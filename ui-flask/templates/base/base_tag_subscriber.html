{% extends "base/base.html" %}

{% block tag_runtime %}
<script src="/static/socket.io.min.js"></script>
<script>
console.log("=== base_tag_subscriber loaded ===");

(function () {
    const tagSocket = io("/tags");

    window.TagRuntime = {
        socket: tagSocket,
        connected: false,
        write(tag, value) {
            if (!this.connected) return;
            tagSocket.emit("tag_write", { tag, value });
        }
    };

    tagSocket.on("connect", () => {
        console.log("[TagRuntime] connected");

        const payload = {
            tags: Array.isArray(window.TAG_SUBSCRIPTIONS)
                ? window.TAG_SUBSCRIPTIONS
                : []
        };

        tagSocket.emit("subscribe", payload);
    });

    tagSocket.on("tag_update", payload => {
        if (window.onTagUpdate) {
            window.onTagUpdate(payload.tags);
        }
    });
})();
</script>
{% endblock %}

