{% extends "base/base.html" %}

{% block head %}
{{ super() }}
<script src="/static/socket.io.min.js"></script>
{% endblock %}

{% block body %}
{{ super() }}

<script>
/*
 * Tag Runtime â€“ Phase 2
 * --------------------
 * Adds explicit tag list subscription
 *
 * Page may define:
 *   window.TAG_SUBSCRIPTIONS = [ "tag.a", "tag.b" ]
 *   window.TAG_UPDATE_RATE_MS = <number>   (optional)
 */

(function () {

    if (typeof io === "undefined") {
        console.error("Tag runtime failed: Socket.IO not available");
        return;
    }
    console.log("Connecting to /tags namespace");
    const tagSocket = io("/tags");

    window.TagRuntime = {
        socket: tagSocket,
        connected: false,
        lastUpdateTs: null,

        write: function (tag, value) {
            if (!this.connected) {
                console.warn("[TagRuntime] write ignored (not connected)");
                return;
            }

            tagSocket.emit("tag_write", {
                tag: tag,
                value: value,
                ts: Date.now() / 1000
            });
        }
    };

    tagSocket.on("connect", () => {
        console.log("[TagRuntime] connected");
        TagRuntime.connected = true;

        // ---- NEW PART ----
        const payload = {
            tags: Array.isArray(window.TAG_SUBSCRIPTIONS)
                ? window.TAG_SUBSCRIPTIONS
                : []
        };

        if (typeof window.TAG_UPDATE_RATE_MS === "number") {
            payload.rate_ms = window.TAG_UPDATE_RATE_MS;
        }

        tagSocket.emit("subscribe", payload);
        // ------------------
    });

    tagSocket.on("disconnect", () => {
        console.warn("[TagRuntime] disconnected");
        TagRuntime.connected = false;
    });

    tagSocket.on("tag_update", (payload) => {
        if (!payload || !payload.tags) {
            console.warn("[TagRuntime] malformed update", payload);
            return;
        }

        TagRuntime.lastUpdateTs = payload.ts || null;

        if (typeof window.onTagUpdate === "function") {
            window.onTagUpdate(payload.tags, payload.ts);
        }
    });

})();
</script>

{% block tag_runtime_scripts %}{% endblock %}
{% endblock %}
